#!/usr/bin/env python
"""

Written by Tiger Sachse.
"""
import time
import json
import rospy
import rostest
import httplib
import unittest
import threading
import std_msgs.msg
import geometry_msgs.msg


#
PACKAGE_NAME = "ezrassor_controller_server"
DEFAULT_TEST_NAME = "test_controller_server"
POST_HEADER = {
    "content-type" : "application/json",
}


class Instruction():
    """"""
    def __init__(self):
        """"""
        self.__content = None
        self.__content_is_new = False
        self.__content_lock = threading.Lock()

    def update(self, content):
        """"""
        self.__content_lock.acquire()
        self.__content_is_new = True
        self.__content = content
        self.__content_lock.release()

    def get(self):
        """"""
        self.__content_lock.acquire()
        content = None
        if self.__content_is_new:
            self.__content_is_new = False
            content = self.__content
        self.__content_lock.release()

        return content


class TestControllerServer(unittest.TestCase):
    """"""
    def __init__(self, *arguments, **keyword_arguments):
        """"""
        super(TestControllerServer, self).__init__(*arguments, **keyword_arguments)
        rospy.init_node(DEFAULT_TEST_NAME)
        
        self.__server_url = rospy.get_param(rospy.get_name() + "/server_url")
        self.__port = int(rospy.get_param(rospy.get_name() + "/port"))
        wheel_instructions_topic = rospy.get_param(
            rospy.get_name() + "/wheel_instructions_topic",
        )
        front_arm_instructions_topic = rospy.get_param(
            rospy.get_name() + "/front_arm_instructions_topic",
        )
        back_arm_instructions_topic = rospy.get_param(
            rospy.get_name() + "/back_arm_instructions_topic",
        )
        front_drum_instructions_topic = rospy.get_param(
            rospy.get_name() + "/front_drum_instructions_topic",
        )
        back_drum_instructions_topic = rospy.get_param(
            rospy.get_name() + "/back_drum_instructions_topic",
        )
        startup_delay = float(
            rospy.get_param(rospy.get_name() + "/startup_delay"),
        )
        self.__communication_delay = float(
            rospy.get_param(rospy.get_name() + "/communication_delay"),
        )

        rospy.Subscriber(
            wheel_instructions_topic,
            geometry_msgs.msg.Twist,
            callback=self.__collect_wheel_instruction,
        )
        rospy.Subscriber(
            front_arm_instructions_topic,
            std_msgs.msg.Float32,
            callback=self.__collect_front_arm_instruction,
        )
        rospy.Subscriber(
            back_arm_instructions_topic,
            std_msgs.msg.Float32,
            callback=self.__collect_back_arm_instruction,
        )
        rospy.Subscriber(
            front_drum_instructions_topic,
            std_msgs.msg.Float32,
            callback=self.__collect_front_drum_instruction,
        )
        rospy.Subscriber(
            back_drum_instructions_topic,
            std_msgs.msg.Float32,
            callback=self.__collect_back_drum_instruction,
        )

        self.__instructions = {
            "wheel" : Instruction(),
            "front_arm" : Instruction(),
            "back_arm" : Instruction(),
            "front_drum" : Instruction(),
            "back_drum" : Instruction(),
        }

        # Sleep for a bit to give ROS and all other nodes time to start up.
        time.sleep(startup_delay)

    def __post(self, payload):
        """"""
        connection = httplib.HTTPConnection(self.__server_url, self.__port)
        #connection.close()
        connection.request("POST", "", json.dumps(payload), POST_HEADER)

    def __collect_wheel_instruction(self, content):
        """"""
        self.__instructions["wheel"].collect(content)

    def __collect_front_arm_instruction(self, content):
        """"""
        self.__instructions["front_arm"].collect(content)

    def __collect_back_arm_instruction(self, content):
        """"""
        self.__instructions["back_arm"].collect(content)

    def __collect_front_drum_instruction(self, content):
        """"""
        self.__instructions["front_drum"].collect(content)

    def __collect_back_drum_instruction(self, content):
        """"""
        self.__instructions["back_drum"].collect(content)

    def __observe_wheel_instruction(self):
        """"""
        return self.__instructions["wheel"].get()

    def __observe_front_arm_instruction(self):
        """"""
        return self.__instructions["front_arm"].get()

    def __observe_back_arm_instruction(self):
        """"""
        return self.__instructions["back_arm"].get()

    def __observe_front_drum_instruction(self):
        """"""
        return self.__instructions["front_drum"].get()

    def __observe_back_drum_instruction(self):
        """"""
        return self.__instructions["back_drum"].get()

    def test_test_me_daddy(self):
        """"""
        self.__post({"autonomous_toggles" : 1})
        self.assertEqual(1,1)


# Start this node with some default values.
rostest.rosrun(
    PACKAGE_NAME,
    DEFAULT_TEST_NAME,
    TestControllerServer,
)
