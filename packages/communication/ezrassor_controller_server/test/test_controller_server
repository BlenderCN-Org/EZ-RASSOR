#!/usr/bin/env python
"""

Written by Tiger Sachse.
"""
import time
import json
import rospy
import random
import rostest
import httplib
import unittest
import threading
import std_msgs.msg
import geometry_msgs.msg


#
ITERATION_RANGE = 10
COORDINATE_MAX = 1337
COORDINATE_MIN = -1337
AUTONOMOUS_TOGGLES_INTEGERS = (1, 2, 4, 8)
PACKAGE_NAME = "ezrassor_controller_server"
DEFAULT_TEST_NAME = "test_controller_server"
POST_HEADER = {"content-type" : "application/json"}
WHEEL_INSTRUCTION_STRINGS = ("forward", "backward", "left", "right")


class Instruction():
    """"""
    def __init__(self, name):
        """"""
        self.name = name
        self.__content = None
        self.__content_is_new = False
        self.__content_lock = threading.Lock()

    def update(self, content):
        """"""
        self.__content_lock.acquire()
        self.__content_is_new = True
        self.__content = content
        self.__content_lock.release()

    def get(self):
        """"""
        self.__content_lock.acquire()
        content = None
        if self.__content_is_new:
            self.__content_is_new = False
            content = self.__content
        self.__content_lock.release()

        return content


class TestControllerServer(unittest.TestCase):
    """"""
    def __init__(self, *arguments, **keyword_arguments):
        """"""
        super(TestControllerServer, self).__init__(*arguments, **keyword_arguments)
        rospy.init_node(DEFAULT_TEST_NAME)
        
        self.__server_url = rospy.get_param(rospy.get_name() + "/server_url")
        self.__port = int(rospy.get_param(rospy.get_name() + "/port"))
        wheel_instructions_topic = rospy.get_param(
            rospy.get_name() + "/wheel_instructions_topic",
        )
        front_arm_instructions_topic = rospy.get_param(
            rospy.get_name() + "/front_arm_instructions_topic",
        )
        back_arm_instructions_topic = rospy.get_param(
            rospy.get_name() + "/back_arm_instructions_topic",
        )
        front_drum_instructions_topic = rospy.get_param(
            rospy.get_name() + "/front_drum_instructions_topic",
        )
        back_drum_instructions_topic = rospy.get_param(
            rospy.get_name() + "/back_drum_instructions_topic",
        )
        autonomous_toggles_topic = "/autonomous_toggles"
        target_coordinates_topic = "/target_coordinates"
        startup_delay = float(
            rospy.get_param(rospy.get_name() + "/startup_delay"),
        )
        self.__communication_delay = float(
            rospy.get_param(rospy.get_name() + "/communication_delay"),
        )

        self.__wheel_instruction = Instruction("wheel_instruction")
        self.__front_arm_instruction = Instruction("front_arm_instruction")
        self.__back_arm_instruction = Instruction("back_arm_instruction")
        self.__front_drum_instruction = Instruction("front_drum_instruction")
        self.__back_drum_instruction = Instruction("back_drum_instruction")
        self.__autonomous_toggles_instruction = Instruction("autonomous_toggles")
        self.__target_coordinate_instruction = Instruction("target_coordinate")

        rospy.Subscriber(
            wheel_instructions_topic,
            geometry_msgs.msg.Twist,
            callback=self.__wheel_instruction.update,
        )
        rospy.Subscriber(
            front_arm_instructions_topic,
            std_msgs.msg.Float32,
            callback=self.__front_arm_instruction.update,
        )
        rospy.Subscriber(
            back_arm_instructions_topic,
            std_msgs.msg.Float32,
            callback=self.__back_arm_instruction.update,
        )
        rospy.Subscriber(
            front_drum_instructions_topic,
            std_msgs.msg.Float32,
            callback=self.__front_drum_instruction.update,
        )
        rospy.Subscriber(
            back_drum_instructions_topic,
            std_msgs.msg.Float32,
            callback=self.__back_drum_instruction.update,
        )
        rospy.Subscriber(
            autonomous_toggles_topic,
            std_msgs.msg.Int8,
            callback=self.__autonomous_toggles_instruction.update,
        )
        rospy.Subscriber(
            target_coordinates_topic,
            geometry_msgs.msg.Point,
            callback=self.__target_coordinate_instruction.update,
        )

        # Sleep for a bit to give ROS and all other nodes time to start up.
        time.sleep(startup_delay)

    def __post_and_sleep(self, payload):
        """"""
        connection = httplib.HTTPConnection(self.__server_url, self.__port)
        connection.request("POST", "", json.dumps(payload), POST_HEADER)
        time.sleep(self.__communication_delay)
        #connection.close()

    def __get_random_speed(self):
        """"""
        speed = random.random()
        if random.random() > .5:
            speed = -speed

        return speed

    def test_simple_instructions(self):
        """"""
        FLOAT_INSTRUCTIONS = (
            self.__front_arm_instruction,
            self.__back_arm_instruction,
            self.__front_drum_instruction,
            self.__back_drum_instruction,
        )

        for instruction in FLOAT_INSTRUCTIONS:
            for iteration in range(ITERATION_RANGE):
                speed = self.__get_random_speed()
                self.assertEqual(instruction.get(), None)
                self.__post_and_sleep({instruction.name : speed})
                received_instruction = instruction.get()
                self.assertNotEqual(received_instruction, None)
                self.assertAlmostEqual(received_instruction.data, speed, places=4)

    def _test_complex_instructions(self):
        """"""
        def build_complex_instruction():
            """"""
            instruction = {}
            instruction["wheel_instruction"] = random.choice(
                WHEEL_INSTRUCTION_STRINGS,
            )
            instruction["front_arm_instruction"] = self.__get_random_speed()
            instruction["back_arm_instruction"] = self.__get_random_speed()
            instruction["front_drum_instruction"] = self.__get_random_speed()
            instruction["back_drum_instruction"] = self.__get_random_speed()
            instruction["autonomous_toggles"] = random.choice(
                AUTONOMOUS_TOGGLES_INTEGERS,
            )
            instruction["target_coordinate"] = {
                "x" : random.randrange(COORDINATE_MIN, COORDINATE_MAX),
                "y" : random.randrange(COORDINATE_MIN, COORDINATE_MAX),
            }
            instruction.pop(random.choice(instruction.keys()))

            return instruction

        for iteration in range(ITERATION_RANGE):
            self.assertEqual(self.__back_arm_instruction.get(), None)
            self.assertEqual(self.__front_drum_instruction.get(), None)
            self.assertEqual(self.__back_drum_instruction.get(), None)
            self.assertEqual(self.__wheel_instruction.get(), None)
            self.assertEqual(self.__autonomous_toggles_instruction.get(), None)
            self.assertEqual(self.__target_coordinate_instruction.get(), None)
            instruction = build_complex_instruction()
            self.__post_and_sleep(instruction)
            


# Start this node with some default values.
rostest.rosrun(
    PACKAGE_NAME,
    DEFAULT_TEST_NAME,
    TestControllerServer,
)
